<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <link rel="stylesheet" href="stylesheet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <script src="jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="js/querystring.js"></script>
    <script type="text/javascript" src="moment.min.js"></script>
    <title>Maps to GPX</title>
</head>
<body>
    <div id="map"></div>
    <form>
        <label for="url">Plak hier uw Google Maps route URL: </label>
        <input type="text" id="url" name="url"/>
        <button type="button" onclick="convertGoogleMapsLink()">convert</button>
    </form>
</body>
<script>
    const map = L.map('map').setView([52.081057821773804, 4.324206744627572], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    }).addTo(map);

    function convertGoogleMapsLink() {
        toggleError(false);
        try {
            var text = $('#url').val();
            
            // Check if the link starts with a http or https
            if( text.substr(0, 7) !== "http://" && text.substr(0, 8) !== "https://" ) {
                toggleError(true, "Link does not look to be a valid Google Maps directions link.");
                return;
            }
            
            if( text.indexOf("maps/place") != -1 ) {
                toggleError(true, "This link is not valid as it only refers to a single place and not directions between two or more places.");
                return;
            }
                    
            var g_idx= text.indexOf("/maps/dir/");

            if( g_idx == -1 ) {
                // Ok so it is not a long link, maybe it is a shortened one (https://goo.gl/maps/bWmHpSmnWGE2)? or the new https://maps.app.goo.gl/sA9oL2awJYPbfs4x9 format
                g_idx = text.indexOf("goo.gl/maps");
                if ( g_idx == -1 ) {
                    g_idx = text.indexOf("maps.app.goo.gl/");
                }
                if( g_idx == -1 ) {
                    toggleError(true, "Link does not look to be a valid Google Maps directions link.");
                    return;
                }
            } else {
                // Adjust the long link to point only to the data part
                g_idx = g_idx + 10;
                
                // Validate that the full link has no empty sections before we pass it along (this will also be caught by the core conversion logic for short urls)
                var link_sections = text.substring(g_idx).split("/");
                
                // Skip the first section as it can be a valid directions link if it is empty
                for (i=1; i<link_sections.length; ++i) {
                    var section = link_sections[i];
                    console.log(section);

                    if( section == null || section.replace('\'','').trim().length <= 1 ) {
                        toggleError(true, "This maps link has missing data. To maintain maximum accuracy, there must not be any empty sections between \'/\'.");
                        return;
                    }	
                }
            }
            
            // Check to see if the url contains the weird xxxxxxxxxxx section, I don´t know why this appears in 
            // the urls... 
            if( text.toLowerCase().indexOf("xxxxxxxxxxx") != -1 ) {
                toggleError(true, "The map link is invalid, there is a crossed out section \'xxxxxxxxxxx\' present. Please attempt to copy link again.");
                return;
            }
            
            var g_data = text.substring(g_idx);
                    
            var pointOutType = $('input#pointType2').is(':checked') ? "track": $('input#pointType3').is(':checked') ? "fixed" : "route";
            var isJson = $('input#outputType2').is(':checked');
            
            var isNextTurnOn = $('input#nextTurnOn').is(':checked');
            var isDirectionsOn = $('input#directionsOn').is(':checked');
            var useDirectionsAsWptNames = isDirectionsOn && $('input#directionsAsWptNamesOn').is(':checked');
            
            var isCreateWaypointsOn = $('input#createWaypoints').is(':checked');
            var isCustomRouteNameOn = $('input#customRouteName').is(':checked');
            
            var isIncludeElevationOn = $('input#retrieveElevationData').is(':checked');
            
            var customRouteName = $('#customRouteNameText').val();
            var isLanguageSelected = $('input#language').is(':checked');
            var language = $("#languageValue").children("option").filter(":selected").val()
                    
            var customRouteQueryString = "";
            if( isCustomRouteNameOn && customRouteName != null && customRouteName.trim().length > 0 )
                customRouteQueryString = "&rn="+encodeURIComponent(customRouteName);
                
            var date_str = moment().format("YYYYMMDD_HHmmss");
                    
            var qs_data = encodeURIComponent(g_data);
            var base_url = window.location.origin + "/";
            console.log(base_url);
            var url = base_url+"load.php?d=default&lang="+(isLanguageSelected ? language : "en")+"&elev="+(isIncludeElevationOn? "on":"off")+"&tmode=off&pttype="+pointOutType+"&o="+(isJson ? "json": "gpx")+"&cmt="+(isNextTurnOn ? "on": "off")+"&desc="+(isDirectionsOn ? "on": "off")+"&descasname="+(useDirectionsAsWptNames ? "on": "off")+"&w="+(isCreateWaypointsOn ? "on": "off")+customRouteQueryString+"&dtstr="+date_str+"&gdata="+qs_data;
            console.log(url);
            window.location = url;
        } catch( e ) {
            toggleError(true, e);
        }
    }

    function toggleError(show) {
        console.log(show, null);
        // toggleError(show, null);
    }
</script>
</html>


